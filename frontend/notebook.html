<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook - Japanese Learning Hub</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="light-theme.css">
    <link rel="stylesheet" href="notebook.css">
</head>
<body>
    <div class="app-layout" id="appLayout">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span class="plus-icon">+</span> New Chat
                </button>
                <button class="ai-doc-gen-btn" onclick="showLLMDocumentModal()">
                    <span>ü§ñ</span> AI Document Generator
                </button>
                <button class="notebook-btn active" onclick="goToNotebook()">
                    <span>üìì</span> Notebook
                </button>
            </div>

            <div class="notebook-nav">
                <div class="nav-item active" data-section="vocabulary" onclick="switchSection('vocabulary')">
                    <span class="nav-icon">üìö</span>
                    <span class="nav-text">Vocabulary</span>
                    <span class="nav-count" id="vocabCount">0</span>
                </div>
                <div class="nav-item" data-section="exercises" onclick="switchSection('exercises')">
                    <span class="nav-icon">‚úèÔ∏è</span>
                    <span class="nav-text">Exercises</span>
                    <span class="nav-count" id="exerciseCount">0</span>
                </div>
                <div class="nav-item" data-section="repetition" onclick="switchSection('repetition')">
                    <span class="nav-icon">üîÑ</span>
                    <span class="nav-text">Practice</span>
                    <span class="nav-count" id="practiceCount">0</span>
                </div>
                <div class="nav-item" data-section="guides" onclick="switchSection('guides')">
                    <span class="nav-icon">üìñ</span>
                    <span class="nav-text">Study Guides</span>
                </div>
                <div class="nav-item" data-section="reminders" onclick="switchSection('reminders')">
                    <span class="nav-icon">‚è∞</span>
                    <span class="nav-text">Reminders</span>
                </div>
            </div>

            <div class="about-section">
                <div class="about-title">About</div>
                <div class="about-content">
                    <p><strong>Japanese AI Tutor</strong> <span class="version-badge">v1.5</span></p>
                    <p>Your personal AI-powered Japanese learning companion!</p>
                    <div class="about-links">
                        <a href="#" class="about-link" onclick="showHelp()">Help</a>
                        <a href="#" class="about-link" onclick="showSettings()">Settings</a>
                        <a href="#" class="about-link" onclick="showFeedback()">Feedback</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="notebook-container">
            <div class="notebook-header">
                <div class="header-content">
                    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12h18M3 6h18M3 18h18"/>
                        </svg>
                    </button>
                    <a href="chat.html" class="flag" title="Return to chat">üáØüáµ</a>
                    <h1>üìì Learning Notebook</h1>
                    <h2>Your personal Japanese study hub</h2>
                    <button class="theme-toggle-btn" id="themeToggle" title="Toggle theme">
                        <svg class="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3" stroke="white" stroke-width="2"/>
                            <line x1="12" y1="21" x2="12" y2="23" stroke="white" stroke-width="2"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="white" stroke-width="2"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="white" stroke-width="2"/>
                            <line x1="1" y1="12" x2="3" y2="12" stroke="white" stroke-width="2"/>
                            <line x1="21" y1="12" x2="23" y2="12" stroke="white" stroke-width="2"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="white" stroke-width="2"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="white" stroke-width="2"/>
                        </svg>
                        <svg class="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Vocabulary Section -->
            <div class="notebook-section active" id="vocabulary-section">
                <div class="section-header">
                    <h2>üìö Vocabulary Dictionary</h2>
                    <button class="add-btn" onclick="showAddVocabularyModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Word
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" placeholder="Search vocabulary..." id="vocabSearch" onkeyup="searchVocabulary()">
                    <select id="levelFilter" onchange="filterVocabulary()">
                        <option value="all">All Levels</option>
                        <option value="N5">N5</option>
                        <option value="N4">N4</option>
                        <option value="N3">N3</option>
                        <option value="N2">N2</option>
                        <option value="N1">N1</option>
                    </select>
                    <select id="typeFilter" onchange="filterVocabulary()">
                        <option value="all">All Types</option>
                        <option value="noun">Nouns</option>
                        <option value="verb">Verbs</option>
                        <option value="adjective">Adjectives</option>
                        <option value="adverb">Adverbs</option>
                        <option value="particle">Particles</option>
                    </select>
                </div>

                <div class="vocabulary-grid" id="vocabularyGrid">
                    <!-- Vocabulary cards will be populated here -->
                </div>
            </div>

            <!-- Exercises Section -->
            <div class="notebook-section" id="exercises-section">
                <div class="section-header">
                    <h2>‚úèÔ∏è Practice Exercises</h2>
                    <button class="add-btn" onclick="showExerciseModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Create Exercise
                    </button>
                </div>

                <div class="exercise-categories">
                    <div class="category-card" onclick="startExercise('kanji')">
                        <div class="category-icon">Êº¢</div>
                        <h3>Kanji Practice</h3>
                        <p>Practice writing and reading kanji characters</p>
                        <div class="difficulty-badge">Intermediate</div>
                    </div>

                    <div class="category-card" onclick="startExercise('grammar')">
                        <div class="category-icon">ÊñáÊ≥ï</div>
                        <h3>Grammar Drills</h3>
                        <p>Test your grammar knowledge</p>
                        <div class="difficulty-badge">All Levels</div>
                    </div>

                    <div class="category-card" onclick="startExercise('vocabulary')">
                        <div class="category-icon">ÂçòË™û</div>
                        <h3>Vocabulary Quiz</h3>
                        <p>Test your word knowledge</p>
                        <div class="difficulty-badge">All Levels</div>
                    </div>

                    <div class="category-card" onclick="startExercise('listening')">
                        <div class="category-icon">ËÅû„Åè</div>
                        <h3>Listening Practice</h3>
                        <p>Improve your listening skills</p>
                        <div class="difficulty-badge">Advanced</div>
                    </div>
                </div>

                <div class="recent-exercises">
                    <h3>Recent Practice Sessions</h3>
                    <div class="exercise-list" id="recentExercises">
                        <!-- Recent exercises will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Repetition Section -->
            <div class="notebook-section" id="repetition-section">
                <div class="section-header">
                    <h2>üîÑ Spaced Repetition Practice</h2>
                    <button class="practice-btn" onclick="startSpacedRepetition()">
                        <span>üéØ</span> Start Practice
                    </button>
                </div>

                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-number">15</div>
                        <div class="stat-label">Words to Review</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">89%</div>
                        <div class="stat-label">Accuracy Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">7</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">234</div>
                        <div class="stat-label">Total Learned</div>
                    </div>
                </div>

                <div class="repetition-queue">
                    <h3>Today's Review Queue</h3>
                    <div class="queue-list" id="reviewQueue">
                        <!-- Review queue items will be populated here -->
                    </div>
                </div>

                <div class="progress-chart">
                    <h3>Learning Progress</h3>
                    <canvas id="progressChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Study Guides Section -->
            <div class="notebook-section" id="guides-section">
                <div class="section-header">
                    <h2>üìñ Study Guides</h2>
                    <button class="add-btn" onclick="showGuideModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Create Guide
                    </button>
                </div>

                <div class="guide-categories">
                    <div class="guide-category active" onclick="filterGuides('all')">All Guides</div>
                    <div class="guide-category" onclick="filterGuides('grammar')">Grammar</div>
                    <div class="guide-category" onclick="filterGuides('kanji')">Kanji</div>
                    <div class="guide-category" onclick="filterGuides('culture')">Culture</div>
                    <div class="guide-category" onclick="filterGuides('phrases')">Phrases</div>
                </div>

                <div class="guides-grid" id="guidesGrid">
                    <!-- Study guides will be populated here -->
                </div>
            </div>

            <!-- Reminders Section -->
            <div class="notebook-section" id="reminders-section">
                <div class="section-header">
                    <h2>‚è∞ Study Reminders</h2>
                    <button class="add-btn" onclick="showReminderModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Set Reminder
                    </button>
                </div>

                <div class="reminder-schedule">
                    <div class="schedule-card">
                        <h3>Daily Goals</h3>
                        <div class="goal-item">
                            <input type="checkbox" id="dailyVocab" checked>
                            <label for="dailyVocab">Learn 5 new vocabulary words</label>
                        </div>
                        <div class="goal-item">
                            <input type="checkbox" id="dailyGrammar" checked>
                            <label for="dailyGrammar">Practice grammar for 15 minutes</label>
                        </div>
                        <div class="goal-item">
                            <input type="checkbox" id="dailyReview" checked>
                            <label for="dailyReview">Review spaced repetition</label>
                        </div>
                    </div>

                    <div class="schedule-card">
                        <h3>Weekly Schedule</h3>
                        <div class="week-schedule">
                            <div class="day-item">
                                <span class="day-name">Monday</span>
                                <span class="day-task">Kanji Practice</span>
                            </div>
                            <div class="day-item">
                                <span class="day-name">Wednesday</span>
                                <span class="day-task">Grammar Review</span>
                            </div>
                            <div class="day-item">
                                <span class="day-name">Friday</span>
                                <span class="day-task">Vocabulary Test</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="upcoming-reminders">
                    <h3>Upcoming Reminders</h3>
                    <div class="reminder-list" id="reminderList">
                        <!-- Reminders will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="vocabularyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Vocabulary</h3>
                <button class="modal-close" onclick="closeModal('vocabularyModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="vocabularyForm">
                    <div class="form-group">
                        <label>Japanese Word</label>
                        <input type="text" id="japaneseWord" required>
                    </div>
                    <div class="form-group">
                        <label>Romaji</label>
                        <input type="text" id="romajiWord" required>
                    </div>
                    <div class="form-group">
                        <label>English Meaning</label>
                        <input type="text" id="englishMeaning" required>
                    </div>
                    <div class="form-group">
                        <label>JLPT Level</label>
                        <select id="jlptLevel">
                            <option value="N5">N5</option>
                            <option value="N4">N4</option>
                            <option value="N3">N3</option>
                            <option value="N2">N2</option>
                            <option value="N1">N1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Word Type</label>
                        <select id="wordType">
                            <option value="noun">Noun</option>
                            <option value="verb">Verb</option>
                            <option value="adjective">Adjective</option>
                            <option value="adverb">Adverb</option>
                            <option value="particle">Particle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Example Sentence</label>
                        <textarea id="exampleSentence" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="vocabularyNotes" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeModal('vocabularyModal')" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Add Vocabulary</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let vocabularyData = [];
        let notebookEntries = [];
        let exerciseData = [];
        let exercisesData = [];
        let guidesData = [];
        let remindersData = [];
        let currentSection = 'vocabulary';

        // Initialize notebook with backend
        async function initializeNotebookWithBackend() {
            try {
                isNotebookLoading = true;
                showLoadingState();
                
                // Wait a bit for services to initialize
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Load data from backend
                await loadBackendData();
                
                // Update all sections
                updateAllSections();
                
                // Load statistics
                await loadStatistics();
                
            } catch (error) {
                console.error('Failed to initialize notebook:', error);
                NotebookAPI.handleApiError(error, 'initializing notebook');
                
                // Fallback to localStorage if backend fails
                loadLocalStorageData();
            } finally {
                isNotebookLoading = false;
                hideLoadingState();
            }
        }

        // Load data from backend API
        async function loadBackendData() {
            try {
                // Load vocabulary
                const vocabResult = await NotebookAPI.getVocabulary();
                vocabularyData = Array.isArray(vocabResult?.vocabulary) ? vocabResult.vocabulary : [];

                // Load exercises and guides
                const [exercisesResult, guidesResult] = await Promise.all([
                    NotebookAPI.getNotebookEntries({ type: 'exercise' }),
                    NotebookAPI.getNotebookEntries({ type: 'guide' })
                ]);

                exercisesData = Array.isArray(exercisesResult?.entries) ? exercisesResult.entries : [];
                guidesData = Array.isArray(guidesResult?.entries) ? guidesResult.entries : [];

                // Load reminders from localStorage (still client-side)
                try {
                    const savedReminders = localStorage.getItem('notebookReminders');
                    if (savedReminders) {
                        const parsed = JSON.parse(savedReminders);
                        remindersData = Array.isArray(parsed) ? parsed : [];
                    }
                } catch (reminderError) {
                    console.warn('Error loading reminders from localStorage:', reminderError);
                    remindersData = [];
                }

                console.log('Backend data loaded successfully');
                console.log(`  Vocabulary: ${vocabularyData.length} items`);
                console.log(`  Exercises: ${exercisesData.length} items`);
                console.log(`  Guides: ${guidesData.length} items`);
            } catch (error) {
                console.error('Error loading backend data:', error);
                // Ensure all arrays are initialized even on error
                if (!Array.isArray(vocabularyData)) vocabularyData = [];
                if (!Array.isArray(exercisesData)) exercisesData = [];
                if (!Array.isArray(guidesData)) guidesData = [];
                if (!Array.isArray(remindersData)) remindersData = [];
                throw error;
            }
        }

        // Load statistics from backend
        async function loadStatistics() {
            try {
                const stats = await NotebookAPI.getStatistics();
                updateCounts(stats);
            } catch (error) {
                console.warn('Failed to load statistics:', error);
                updateCounts();
            }
        }

        // Load localStorage data as fallback
        function loadLocalStorageData() {
            vocabularyData = JSON.parse(localStorage.getItem('notebookVocabulary') || '[]');
            notebookEntries = JSON.parse(localStorage.getItem('notebookEntries') || '[]');
            exercisesData = JSON.parse(localStorage.getItem('notebookExercises') || '[]');
            guidesData = JSON.parse(localStorage.getItem('notebookGuides') || '[]');
            remindersData = JSON.parse(localStorage.getItem('notebookReminders') || '[]');
        }

        // Update counts in navigation
        function updateCounts(stats = null) {
            const vocabCount = document.getElementById('vocabCount');
            const exerciseCount = document.getElementById('exerciseCount');
            const practiceCount = document.getElementById('practiceCount');
            
            if (vocabCount) {
                vocabCount.textContent = vocabularyData.length;
            }
            if (exerciseCount) {
                exerciseCount.textContent = exercisesData.length;
            }
            if (practiceCount) {
                // Count items needing practice
                const practiceNeeded = vocabularyData.filter(word => 
                    word.masteryLevel < 3 || word.reviewCount === 0
                ).length;
                practiceCount.textContent = practiceNeeded;
            }
        }

        // Fallback to localStorage
        function loadLocalStorageData() {
            const savedVocab = localStorage.getItem('notebookVocabulary');
            const savedExercises = localStorage.getItem('notebookExercises');
            const savedGuides = localStorage.getItem('notebookGuides');
            const savedReminders = localStorage.getItem('notebookReminders');

            if (savedVocab) vocabularyData = JSON.parse(savedVocab);
            if (savedExercises) exercisesData = JSON.parse(savedExercises);
            if (savedGuides) guidesData = JSON.parse(savedGuides);
            if (savedReminders) remindersData = JSON.parse(savedReminders);

            updateAllSections();
            showNotification('Using offline mode - some features may be limited', 'warning');
        }

        // Load statistics from backend
        async function loadStatistics() {
            try {
                const stats = await NotebookAPI.getLearningOverview();
                updateStatisticsDisplay(stats);
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Update statistics display
        function updateStatisticsDisplay(stats) {
            // Update vocabulary count
            const vocabCount = document.getElementById('vocabCount');
            if (vocabCount) vocabCount.textContent = stats.vocabulary?.total || 0;
            
            // Update exercise count
            const exerciseCount = document.getElementById('exerciseCount');
            if (exerciseCount) exerciseCount.textContent = stats.notebooks?.byType?.exercise || 0;
            
            // Update practice count
            const practiceCount = document.getElementById('practiceCount');
            if (practiceCount) practiceCount.textContent = stats.vocabulary?.dueForReview || 0;
            
            // Update spaced repetition stats
            updateSpacedRepetitionStats(stats);
        }

        // Update spaced repetition statistics
        function updateSpacedRepetitionStats(stats) {
            const statCards = document.querySelectorAll('.stat-number');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.vocabulary?.dueForReview || 0; // Words to Review
                statCards[1].textContent = '89%'; // Accuracy Rate (placeholder)
                statCards[2].textContent = '7'; // Day Streak (placeholder)
                statCards[3].textContent = stats.combined?.totalItems || 0; // Total Learned
            }
        }

        // Show loading state
        function showLoadingState() {
            isNotebookLoading = true;
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'notebookLoading';
            loadingIndicator.className = 'loading-overlay';
            loadingIndicator.innerHTML = `
                <div class="loading-spinner"></div>
                <p>Loading notebook data...</p>
            `;
            document.body.appendChild(loadingIndicator);
        }

        // Hide loading state
        function hideLoadingState() {
            isNotebookLoading = false;
            const loadingIndicator = document.getElementById('notebookLoading');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // Hide loading state
        function hideLoadingState() {
            const loadingIndicator = document.getElementById('notebookLoading');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        // Switch between sections
        function switchSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.notebook-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(`${section}-section`).classList.add('active');

            currentSection = section;
        }

        // Add vocabulary functionality
        function showAddVocabularyModal() {
            document.getElementById('vocabularyModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Vocabulary form submission
        document.getElementById('vocabularyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const vocabulary = {
                    japanese: document.getElementById('japaneseWord').value,
                    romaji: document.getElementById('romajiWord').value,
                    english: document.getElementById('englishMeaning').value,
                    level: document.getElementById('jlptLevel').value,
                    type: document.getElementById('wordType').value,
                    example: document.getElementById('exampleSentence').value,
                    notes: document.getElementById('vocabularyNotes').value,
                    tags: [] // Can be extended later
                };

                // Try to add via backend API
                const newVocab = await NotebookAPI.addVocabulary(vocabulary);
                
                // Add to local data
                vocabularyData.push(newVocab.vocabulary);
                
                // Update display
                updateVocabularyDisplay();
                closeModal('vocabularyModal');
                this.reset();

                showNotification('Vocabulary added successfully!', 'success');
                
            } catch (error) {
                // Fallback to localStorage if backend fails
                console.error('Backend add failed, using localStorage:', error);
                
                const fallbackVocab = {
                    id: Date.now().toString(),
                    ...vocabData,
                    addedDate: new Date().toISOString(),
                    reviewCount: 0,
                    masteryLevel: 0
                };

                vocabularyData.push(fallbackVocab);
                localStorage.setItem('notebookVocabulary', JSON.stringify(vocabularyData));

                updateVocabularyDisplay();
                closeModal('vocabularyModal');
                this.reset();

                showNotification('Vocabulary added locally (offline mode)', 'warning');
            }
        });

        // Update vocabulary display
        function updateVocabularyDisplay() {
            const grid = document.getElementById('vocabularyGrid');
            if (!grid) return;

            grid.innerHTML = '';

            // Ensure vocabularyData is an array
            if (!Array.isArray(vocabularyData)) {
                console.warn('updateVocabularyDisplay: vocabularyData is not an array', vocabularyData);
                vocabularyData = [];
            }

            if (vocabularyData.length === 0) {
                grid.innerHTML = '<p class="empty-message">No vocabulary yet. Add your first word!</p>';
                const countElement = document.getElementById('vocabCount');
                if (countElement) countElement.textContent = '0';
                return;
            }

            vocabularyData.forEach(word => {
                const card = document.createElement('div');
                card.className = 'vocabulary-card';
                card.innerHTML = `
                    <div class="vocab-header">
                        <span class="japanese-text">${word.japanese || ''}</span>
                        <span class="romaji-text">${word.romaji || ''}</span>
                    </div>
                    <div class="vocab-body">
                        <div class="english-meaning">${word.english || ''}</div>
                        <div class="vocab-meta">
                            <span class="level-badge ${(word.level || 'N5').toLowerCase()}">${word.level || 'N5'}</span>
                            <span class="type-badge">${word.type || 'noun'}</span>
                        </div>
                        ${word.example ? `<div class="example-text">${word.example}</div>` : ''}
                        ${word.notes ? `<div class="vocab-notes">${word.notes}</div>` : ''}
                    </div>
                    <div class="vocab-actions">
                        <button onclick="editVocabulary('${word.id}')" class="action-btn edit">‚úèÔ∏è</button>
                        <button onclick="practiceWord('${word.id}')" class="action-btn practice">üîÑ</button>
                        <button onclick="deleteVocabulary('${word.id}')" class="action-btn delete">üóëÔ∏è</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            const countElement = document.getElementById('vocabCount');
            if (countElement) {
                countElement.textContent = vocabularyData.length;
            }
        }

        // Search and filter functionality
        async function searchVocabulary() {
            try {
                const searchTerm = document.getElementById('vocabSearch').value;
                const level = document.getElementById('levelFilter').value;
                const type = document.getElementById('typeFilter').value;

                const filters = {
                    search: searchTerm,
                    level: level,
                    type: type
                };

                // Try backend search first
                const results = await NotebookAPI.getVocabulary(filters);
                displayFilteredVocabulary(results);
                
            } catch (error) {
                console.error('Backend search failed, using local search:', error);
                
                // Fallback to local search
                const searchTerm = document.getElementById('vocabSearch').value.toLowerCase();
                const level = document.getElementById('levelFilter').value;
                const type = document.getElementById('typeFilter').value;

                const filtered = vocabularyData.filter(word => {
                    const matchesSearch = word.japanese.includes(searchTerm) ||
                                         word.romaji.toLowerCase().includes(searchTerm) ||
                                         word.english.toLowerCase().includes(searchTerm);
                    const matchesLevel = level === 'all' || word.level === level;
                    const matchesType = type === 'all' || word.type === type;

                    return matchesSearch && matchesLevel && matchesType;
                });

                displayFilteredVocabulary(filtered);
            }
        }

        async function filterVocabulary() {
            await searchVocabulary();
        }

        function displayFilteredVocabulary(words) {
            const grid = document.getElementById('vocabularyGrid');
            if (!grid) return;

            grid.innerHTML = '';

            // Ensure words is an array
            if (!Array.isArray(words)) {
                console.warn('displayFilteredVocabulary: words is not an array', words);
                words = [];
            }

            if (words.length === 0) {
                grid.innerHTML = '<p class="empty-message">No matching vocabulary found.</p>';
                return;
            }

            words.forEach(word => {
                const card = document.createElement('div');
                card.className = 'vocabulary-card';
                card.innerHTML = `
                    <div class="vocab-header">
                        <span class="japanese-text">${word.japanese || ''}</span>
                        <span class="romaji-text">${word.romaji || ''}</span>
                    </div>
                    <div class="vocab-body">
                        <div class="english-meaning">${word.english || ''}</div>
                        <div class="vocab-meta">
                            <span class="level-badge ${(word.level || 'N5').toLowerCase()}">${word.level || 'N5'}</span>
                            <span class="type-badge">${word.type || 'noun'}</span>
                        </div>
                        ${word.example ? `<div class="example-text">${word.example}</div>` : ''}
                        ${word.notes ? `<div class="vocab-notes">${word.notes}</div>` : ''}
                    </div>
                    <div class="vocab-actions">
                        <button onclick="editVocabulary('${word.id}')" class="action-btn edit">‚úèÔ∏è</button>
                        <button onclick="practiceWord('${word.id}')" class="action-btn practice">üîÑ</button>
                        <button onclick="deleteVocabulary('${word.id}')" class="action-btn delete">üóëÔ∏è</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Exercise functions
        async function startExercise(type) {
            try {
                showNotification(`Starting ${type} exercise...`, 'info');
                
                // Create a simple exercise entry
                const exerciseData = {
                    title: `${type.charAt(0).toUpperCase() + type.slice(1)} Practice`,
                    content: `Practice session for ${type} - ${new Date().toLocaleDateString()}`,
                    type: 'exercise',
                    category: type,
                    difficulty: 'beginner',
                    tags: [type]
                };
                
                const newExercise = await NotebookAPI.createExercise(exerciseData);
                exercisesData.push(newExercise);
                
                showNotification(`${type} exercise created!`, 'success');
                
            } catch (error) {
                console.error('Failed to start exercise:', error);
                showNotification('Failed to start exercise', 'error');
            }
        }

        async function showExerciseModal() {
            try {
                // Simple exercise creation modal (can be enhanced)
                const title = prompt('Exercise title:');
                if (!title) return;
                
                const content = prompt('Exercise content/description:');
                if (!content) return;
                
                const exerciseData = {
                    title: title,
                    content: content,
                    type: 'exercise',
                    category: 'custom',
                    difficulty: 'beginner'
                };
                
                const newExercise = await NotebookAPI.createExercise(exerciseData);
                exercisesData.push(newExercise);
                
                showNotification('Exercise created successfully!', 'success');
                
            } catch (error) {
                console.error('Failed to create exercise:', error);
                showNotification('Failed to create exercise', 'error');
            }
        }

        // Spaced repetition functions
        async function startSpacedRepetition() {
            try {
                showNotification('Loading spaced repetition practice...', 'info');
                
                // Get vocabulary due for review
                const dueForReview = await NotebookAPI.getVocabularyForReview();
                
                if (dueForReview.length === 0) {
                    showNotification('No vocabulary due for review! Great job!', 'success');
                    return;
                }
                
                // Start practice with first item
                const currentVocab = dueForReview[0];
                practiceSpacedRepetitionItem(currentVocab, dueForReview);
                
            } catch (error) {
                console.error('Failed to start spaced repetition:', error);
                showNotification('Failed to start spaced repetition', 'error');
            }
        }

        async function practiceSpacedRepetitionItem(vocab, queue) {
            const score = prompt(`Spaced Repetition Practice\n\n${vocab.japanese} (${vocab.romaji})\n\nMeaning: ${vocab.english}\n\nRate your recall (1-5):`);
            
            if (score && !isNaN(score)) {
                const scoreNum = parseInt(score);
                if (scoreNum >= 1 && scoreNum <= 5) {
                    try {
                        await NotebookAPI.updateVocabularyMastery(vocab.id, scoreNum);
                        
                        // Remove from queue and continue
                        const remainingQueue = queue.filter(item => item.id !== vocab.id);
                        
                        if (remainingQueue.length > 0) {
                            setTimeout(() => {
                                practiceSpacedRepetitionItem(remainingQueue[0], remainingQueue);
                            }, 500);
                        } else {
                            showNotification('Spaced repetition session completed!', 'success');
                            // Refresh display
                            await loadStatistics();
                        }
                        
                    } catch (error) {
                        console.error('Failed to update mastery:', error);
                        showNotification('Failed to record practice', 'error');
                    }
                } else {
                    showNotification('Please enter a score between 1 and 5', 'error');
                }
            }
        }

        // Guide functions
        async function showGuideModal() {
            try {
                // Simple guide creation modal (can be enhanced)
                const title = prompt('Guide title:');
                if (!title) return;
                
                const content = prompt('Guide content:');
                if (!content) return;
                
                const category = prompt('Guide category (grammar, kanji, culture, phrases):') || 'grammar';
                
                const guideData = {
                    title: title,
                    content: content,
                    type: 'guide',
                    category: category,
                    difficulty: 'beginner',
                    tags: [category]
                };
                
                const newGuide = await NotebookAPI.createGuide(guideData);
                guidesData.push(newGuide);
                
                showNotification('Guide created successfully!', 'success');
                
            } catch (error) {
                console.error('Failed to create guide:', error);
                showNotification('Failed to create guide', 'error');
            }
        }

        async function filterGuides(category) {
            try {
                document.querySelectorAll('.guide-category').forEach(cat => {
                    cat.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Filter guides by category
                const filters = category === 'all' ? {} : { category };
                const filteredGuides = await NotebookAPI.getNotebookEntries({
                    ...filters,
                    type: 'guide'
                });
                
                // Update guides display
                updateGuidesDisplay(filteredGuides);
                
            } catch (error) {
                console.error('Failed to filter guides:', error);
                showNotification('Failed to filter guides', 'error');
            }
        }

        function updateGuidesDisplay(guides) {
            const guidesGrid = document.getElementById('guidesGrid');
            if (!guidesGrid) return;

            guidesGrid.innerHTML = '';

            // Ensure guides is an array
            if (!Array.isArray(guides)) {
                console.warn('updateGuidesDisplay: guides is not an array', guides);
                guides = [];
            }

            if (guides.length === 0) {
                guidesGrid.innerHTML = '<p class="empty-message">No guides yet. Create your first guide!</p>';
                return;
            }

            guides.forEach(guide => {
                const guideCard = document.createElement('div');
                guideCard.className = 'guide-card';
                guideCard.innerHTML = `
                    <div class="guide-header">
                        <h3>${guide.title || 'Untitled Guide'}</h3>
                        <span class="guide-category-badge">${guide.category || 'general'}</span>
                    </div>
                    <div class="guide-content">
                        <p>${(guide.content || '').substring(0, 150)}${(guide.content || '').length > 150 ? '...' : ''}</p>
                    </div>
                    <div class="guide-meta">
                        <span class="difficulty-badge">${guide.difficulty || 'beginner'}</span>
                        <span class="date">${guide.createdAt ? new Date(guide.createdAt).toLocaleDateString() : 'Unknown'}</span>
                    </div>
                `;
                guidesGrid.appendChild(guideCard);
            });
        }

        // Reminder functions
        function showReminderModal() {
            showNotification('Reminder creation coming soon!', 'info');
        }

        // Sidebar toggle is handled by js/ui-utils.js

        function goToNotebook() {
            // Already on notebook page
        }

        function startNewChat() {
            window.location.href = 'chat.html';
        }

        function showLLMDocumentModal() {
            showNotification('Document generator coming to notebook soon!', 'info');
        }

        function showHelp() {
            showNotification('Help documentation coming soon!', 'info');
        }

        function showSettings() {
            showNotification('Settings coming soon!', 'info');
        }

        function showFeedback() {
            showNotification('Feedback form coming soon!', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function updateAllSections() {
            updateVocabularyDisplay();
            // Update other sections as needed
        }

        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', function() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }

        // Update all sections
        function updateAllSections() {
            try {
                // Ensure all data arrays are initialized
                if (!Array.isArray(vocabularyData)) vocabularyData = [];
                if (!Array.isArray(guidesData)) guidesData = [];
                if (!Array.isArray(exercisesData)) exercisesData = [];
                if (!Array.isArray(remindersData)) remindersData = [];

                updateVocabularyDisplay();
                updateGuidesDisplay(guidesData);
                // Update other sections as needed
            } catch (error) {
                console.error('Error updating all sections:', error);
                showNotification('Failed to update some sections', 'error');
            }
        }

        // Vocabulary action functions
        async function editVocabulary(id) {
            try {
                const vocab = vocabularyData.find(word => word.id === id);
                if (!vocab) {
                    showNotification('Vocabulary not found', 'error');
                    return;
                }

                // Populate form with existing data
                document.getElementById('japaneseWord').value = vocab.japanese || '';
                document.getElementById('romajiWord').value = vocab.romaji || '';
                document.getElementById('englishMeaning').value = vocab.english || '';
                document.getElementById('jlptLevel').value = vocab.level || 'N5';
                document.getElementById('wordType').value = vocab.type || 'noun';
                document.getElementById('exampleSentence').value = vocab.example || '';
                document.getElementById('vocabularyNotes').value = vocab.notes || '';

                // Show modal
                document.getElementById('vocabularyModal').classList.add('active');

                // Update form submission to handle edit
                const form = document.getElementById('vocabularyForm');
                const originalSubmit = form.onsubmit;
                
                form.onsubmit = async function(e) {
                    e.preventDefault();

                    const updates = {
                        japanese: document.getElementById('japaneseWord').value,
                        romaji: document.getElementById('romajiWord').value,
                        english: document.getElementById('englishMeaning').value,
                        level: document.getElementById('jlptLevel').value,
                        type: document.getElementById('wordType').value,
                        example: document.getElementById('exampleSentence').value,
                        notes: document.getElementById('vocabularyNotes').value
                    };

                    try {
                        // Try backend update
                        const updated = await NotebookAPI.updateVocabulary(id, updates);
                        
                        // Update local data
                        const localIndex = vocabularyData.findIndex(word => word.id === id);
                        if (localIndex !== -1) {
                            vocabularyData[localIndex] = updated;
                        }
                        
                        updateVocabularyDisplay();
                        closeModal('vocabularyModal');
                        form.reset();
                        form.onsubmit = originalSubmit; // Restore original handler
                        
                        showNotification('Vocabulary updated successfully!', 'success');
                        
                    } catch (error) {
                        console.error('Backend update failed, using local update:', error);
                        
                        // Fallback to local update
                        const localIndex = vocabularyData.findIndex(word => word.id === id);
                        if (localIndex !== -1) {
                            vocabularyData[localIndex] = {
                                ...vocabularyData[localIndex],
                                ...updates,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('notebookVocabulary', JSON.stringify(vocabularyData));
                        }
                        
                        updateVocabularyDisplay();
                        closeModal('vocabularyModal');
                        form.reset();
                        form.onsubmit = originalSubmit;
                        
                        showNotification('Vocabulary updated locally (offline mode)', 'warning');
                    }
                };
                
            } catch (error) {
                console.error('Error editing vocabulary:', error);
                showNotification('Failed to edit vocabulary', 'error');
            }
        }

        async function practiceWord(id) {
            try {
                // Get vocabulary details
                const vocab = vocabularyData.find(word => word.id === id);
                if (!vocab) {
                    showNotification('Vocabulary not found', 'error');
                    return;
                }

                // Simple practice interface (can be enhanced)
                const score = prompt(`Practice: ${vocab.japanese} (${vocab.romaji})\n\nMeaning: ${vocab.english}\n\nRate your knowledge (1-5):`);
                
                if (score && !isNaN(score)) {
                    const scoreNum = parseInt(score);
                    if (scoreNum >= 1 && scoreNum <= 5) {
                        try {
                            // Try backend update
                            await NotebookAPI.updateVocabularyMastery(id, scoreNum);
                            
                            // Update local data
                            const localVocab = vocabularyData.find(word => word.id === id);
                            if (localVocab) {
                                localVocab.reviewCount = (localVocab.reviewCount || 0) + 1;
                                localVocab.masteryLevel = (localVocab.masteryLevel || 0) + scoreNum;
                                localVocab.lastReviewed = new Date().toISOString();
                            }
                            
                            updateVocabularyDisplay();
                            showNotification('Practice recorded successfully!', 'success');
                            
                        } catch (error) {
                            console.error('Backend practice update failed, using local update:', error);
                            
                            // Fallback to local update
                            const localVocab = vocabularyData.find(word => word.id === id);
                            if (localVocab) {
                                localVocab.reviewCount = (localVocab.reviewCount || 0) + 1;
                                localVocab.masteryLevel = (localVocab.masteryLevel || 0) + scoreNum;
                                localVocab.lastReviewed = new Date().toISOString();
                                localStorage.setItem('notebookVocabulary', JSON.stringify(vocabularyData));
                            }
                            
                            updateVocabularyDisplay();
                            showNotification('Practice recorded locally (offline mode)', 'warning');
                        }
                    } else {
                        showNotification('Please enter a score between 1 and 5', 'error');
                    }
                }
            } catch (error) {
                console.error('Error in practice:', error);
                showNotification('Practice failed', 'error');
            }
        }

        async function deleteVocabulary(id) {
            if (confirm('Are you sure you want to delete this vocabulary?')) {
                try {
                    // Try backend deletion first
                    await NotebookAPI.deleteVocabulary(id);
                    
                    // Remove from local data
                    vocabularyData = vocabularyData.filter(word => word.id !== id);
                    updateVocabularyDisplay();
                    
                    showNotification('Vocabulary deleted successfully!', 'success');
                    
                } catch (error) {
                    console.error('Backend delete failed, using local deletion:', error);
                    
                    // Fallback to local deletion
                    vocabularyData = vocabularyData.filter(word => word.id !== id);
                    localStorage.setItem('notebookVocabulary', JSON.stringify(vocabularyData));
                    updateVocabularyDisplay();
                    
                    showNotification('Vocabulary deleted locally (offline mode)', 'warning');
                }
            }
        }
    </script>
    <script src="js/app-state.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/notebook-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize DOM references for sidebar functionality
            initializeDOMReferences();
            initializeSidebarState();
            initializeTheme();
            
            // Initialize notebook with backend integration
            initializeNotebookWithBackend();
        });
    </script>
</body>
</html>